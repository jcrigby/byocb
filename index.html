<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat PWA</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI Chat">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: white;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            word-wrap: break-word;
        }

        .message.user {
            background: linear-gradient(135deg, #007AFF 0%, #0051D0 100%);
            align-self: flex-end;
            margin-left: auto;
        }

        .message.assistant {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            align-self: flex-start;
        }

        .message.error {
            background: rgba(255, 59, 48, 0.2);
            border: 1px solid rgba(255, 59, 48, 0.5);
            align-self: flex-start;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-top: 0.25rem;
        }

        .input-container {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-row {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            color: white;
            resize: none;
            max-height: 100px;
            min-height: 44px;
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .send-btn {
            background: linear-gradient(135deg, #007AFF 0%, #0051D0 100%);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        .send-btn:disabled {
            opacity: 0.5;
            transform: none;
        }

        .settings-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            padding: 0.5rem;
            color: white;
            cursor: pointer;
            margin-left: auto;
        }

        .settings-panel {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            padding: 2rem;
            overflow-y: auto;
            display: none;
        }

        .settings-content {
            max-width: 500px;
            margin: 0 auto;
        }

        .setting-group {
            margin-bottom: 1.5rem;
        }

        .setting-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .setting-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: white;
        }

        .setting-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .settings-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007AFF 0%, #0051D0 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .offline-indicator {
            background: rgba(255, 149, 0, 0.9);
            color: white;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.8rem;
            display: none;
        }

        .typing-indicator {
            display: flex;
            gap: 0.25rem;
            padding: 1rem;
            opacity: 0.7;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #007AFF;
            border-radius: 50%;
            animation: typing 1.5s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .empty-state {
            text-align: center;
            margin-top: 2rem;
            opacity: 0.6;
        }

        .debug-log {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .debug-log-header {
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .debug-log-content {
            padding: 0.5rem;
            overflow-x: auto;
            display: none;
        }

        .debug-log-content.expanded {
            display: block;
        }

        .debug-log pre {
            margin: 0;
            white-space: pre-wrap;
        }

        .debug-log-stats {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.7rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .copy-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            cursor: pointer;
            color: white;
        }

        .copy-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="offline-indicator" id="offline-indicator">
            You're offline. Messages will be saved and sent when connection is restored.
        </div>
        
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h1>
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1V3H9V1L3 7V9H21ZM15 11V13H9V11H15ZM15 15V17H9V15H15ZM15 19V21H9V19H15Z"/>
                        </svg>
                        AI Chat
                    </h1>
                    <div class="status" id="status">Ready to chat</div>
                </div>
                <button class="settings-btn" onclick="toggleSettings()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                    </svg>
                </button>
            </div>
        </div>

        <div class="chat-container" id="chat-container">
            <div class="empty-state">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.3; margin-bottom: 1rem;">
                    <path d="M12,2A2,2 0 0,1 14,4C14,4.74 13.6,5.39 13,5.73V7H14A7,7 0 0,1 21,14H22A1,1 0 0,1 23,15V18A1,1 0 0,1 22,19H21C21,20.72 20.37,22.27 19.29,23.36L17.87,21.94C18.5,21.31 18.91,20.44 18.99,19.5L18.99,19.49V19.5H8.5V19.49C8.58,20.44 8.99,21.31 9.62,21.94L8.2,23.36C7.12,22.27 6.5,20.72 6.5,19H5.5A1,1 0 0,1 4.5,18V15A1,1 0 0,1 5.5,14H6.5A7,7 0 0,1 13.5,7H14.5V5.73C13.9,5.39 13.5,4.74 13.5,4A2,2 0 0,1 15.5,2H12M12,4A0.5,0.5 0 0,0 11.5,4.5A0.5,0.5 0 0,0 12,5A0.5,0.5 0 0,0 12.5,4.5A0.5,0.5 0 0,0 12,4Z"/>
                </svg>
                <p>Start a conversation with AI</p>
                <p style="font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.5;">Configure your API key in settings first</p>
            </div>
        </div>

        <div class="input-container">
            <div class="input-row">
                <textarea 
                    id="message-input" 
                    class="input-field" 
                    placeholder="Type your message..."
                    rows="1"></textarea>
                <button id="send-btn" class="send-btn" onclick="sendMessage()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div class="settings-panel" id="settings-panel">
        <div class="settings-content">
            <h2 style="margin-bottom: 2rem;">Settings</h2>
            
            <div class="setting-group">
                <label class="setting-label">OpenRouter API Key</label>
                <input type="password" id="api-key" class="setting-input" placeholder="sk-or-...">
            </div>
            
            <div class="setting-group">
                <label class="setting-label">Model</label>
                <select id="model-select" class="setting-input">
                    <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                    <option value="openai/gpt-4">GPT-4</option>
                    <option value="openai/gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    <option value="meta-llama/llama-3.2-90b-vision-instruct">Llama 3.2 90B</option>
                </select>
            </div>
            
            <div class="setting-group">
                <label class="setting-label">GitHub Token (Optional)</label>
                <input type="password" id="github-token" class="setting-input" placeholder="ghp_...">
            </div>
            
            <div class="setting-group">
                <label class="setting-label">GitHub Repository (Optional)</label>
                <input type="text" id="github-repo" class="setting-input" placeholder="username/repo-name">
            </div>

            <div class="setting-group">
                <label class="setting-label">Debug Options</label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="debug-mode" style="width: auto;">
                    Show Raw API Interaction Logs
                </label>
            </div>
            
            <div class="settings-buttons">
                <button class="btn btn-primary" onclick="saveSettings()">Save</button>
                <button class="btn btn-secondary" onclick="toggleSettings()">Cancel</button>
                <button class="btn btn-secondary" onclick="clearData()" style="margin-left: auto;">Clear All Data</button>
            </div>
        </div>
    </div>

    <script>
        let messages = [];
        let isOnline = navigator.onLine;
        let pendingMessages = [];

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(() => {
                console.log('Service Worker registered');
            });
        }

        // Load saved data on startup
        window.addEventListener('load', () => {
            loadMessages();
            loadSettings();
            updateStatus();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Online/Offline detection
            window.addEventListener('online', () => {
                isOnline = true;
                document.getElementById('offline-indicator').style.display = 'none';
                processPendingMessages();
                updateStatus();
            });

            window.addEventListener('offline', () => {
                isOnline = false;
                document.getElementById('offline-indicator').style.display = 'block';
                updateStatus();
            });

            // Auto-resize textarea
            const textarea = document.getElementById('message-input');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });

            // Enter to send
            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        function updateStatus() {
            const status = document.getElementById('status');
            const apiKey = localStorage.getItem('openrouter_api_key');
            
            if (!isOnline) {
                status.textContent = 'Offline mode';
            } else if (!apiKey) {
                status.textContent = 'Configure API key to start';
            } else {
                status.textContent = 'Ready to chat';
            }
        }

        function loadMessages() {
            const saved = localStorage.getItem('chat_messages');
            if (saved) {
                messages = JSON.parse(saved);
                renderMessages();
            }
        }

        function saveMessages() {
            localStorage.setItem('chat_messages', JSON.stringify(messages));
        }

        function loadSettings() {
            const apiKey = localStorage.getItem('openrouter_api_key');
            const model = localStorage.getItem('selected_model');
            const githubToken = localStorage.getItem('github_token');
            const githubRepo = localStorage.getItem('github_repo');

            if (apiKey) document.getElementById('api-key').value = apiKey;
            if (model) document.getElementById('model-select').value = model;
            if (githubToken) document.getElementById('github-token').value = githubToken;
            if (githubRepo) document.getElementById('github-repo').value = githubRepo;
            document.getElementById('debug-mode').checked = localStorage.getItem('debug_mode') === 'true';
        }

        function saveSettings() {
            const apiKey = document.getElementById('api-key').value;
            const model = document.getElementById('model-select').value;
            const githubToken = document.getElementById('github-token').value;
            const githubRepo = document.getElementById('github-repo').value;
            const debugMode = document.getElementById('debug-mode').checked;

            localStorage.setItem('openrouter_api_key', apiKey);
            localStorage.setItem('selected_model', model);
            localStorage.setItem('github_token', githubToken);
            localStorage.setItem('github_repo', githubRepo);
            localStorage.setItem('debug_mode', debugMode);

            toggleSettings();
            updateStatus();
            renderMessages(); // Refresh to show/hide debug logs
        }

        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        function renderMessages() {
            const container = document.getElementById('chat-container');
            const emptyState = container.querySelector('.empty-state');
            const debugMode = localStorage.getItem('debug_mode') === 'true';
            
            if (messages.length === 0) {
                if (emptyState) emptyState.style.display = 'block';
                return;
            }

            if (emptyState) emptyState.style.display = 'none';

            container.innerHTML = messages.map(msg => `
                <div class="message ${msg.role} ${msg.error ? 'error' : ''}">
                    ${msg.content}
                    <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</div>
                    ${debugMode && msg.debug ? renderDebugLog(msg.debug) : ''}
                </div>
            `).join('');

            container.scrollTop = container.scrollHeight;

            // Add click handlers for debug log toggles
            document.querySelectorAll('.debug-log-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    content.classList.toggle('expanded');
                });
            });

            // Add click handlers for copy buttons
            document.querySelectorAll('.copy-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const content = button.getAttribute('data-content');
                    navigator.clipboard.writeText(content);
                    const originalText = button.textContent;
                    button.textContent = 'Copied!';
                    setTimeout(() => button.textContent = originalText, 1500);
                });
            });
        }

        function renderDebugLog(debug) {
            const request = JSON.stringify(debug.request, null, 2);
            const response = JSON.stringify(debug.response, null, 2);
            
            return `
                <div class="debug-log">
                    <div class="debug-log-header">
                        <span>🔍 Raw API Interaction Log</span>
                        <button class="copy-button" data-content="${escapeHtml(JSON.stringify(debug))}">Copy JSON</button>
                    </div>
                    <div class="debug-log-content">
                        <div>
                            <strong>Request:</strong>
                            <pre>${escapeHtml(request)}</pre>
                        </div>
                        <div style="margin-top: 1rem;">
                            <strong>Response:</strong>
                            <pre>${escapeHtml(response)}</pre>
                        </div>
                        <div class="debug-log-stats">
                            Request Time: ${new Date(debug.requestTime).toISOString()}<br>
                            Response Time: ${new Date(debug.responseTime).toISOString()}<br>
                            Total Tokens: ${debug.response.usage?.total_tokens || 'N/A'}<br>
                            Model: ${debug.response.model || 'N/A'}
                        </div>
                    </div>
                </div>
            `;
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function showTyping() {
            const container = document.getElementById('chat-container');
            const typing = document.createElement('div');
            typing.className = 'typing-indicator';
            typing.id = 'typing-indicator';
            typing.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            container.appendChild(typing);
            container.scrollTop = container.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;

            const userMessage = {
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            };

            messages.push(userMessage);
            input.value = '';
            input.style.height = 'auto';
            renderMessages();
            saveMessages();

            if (!isOnline) {
                pendingMessages.push(userMessage);
                addSystemMessage('Message saved. Will send when back online.');
                return;
            }

            const apiKey = localStorage.getItem('openrouter_api_key');
            if (!apiKey) {
                addSystemMessage('Please configure your OpenRouter API key in settings.');
                return;
            }

            showTyping();

            try {
                const model = localStorage.getItem('selected_model') || 'anthropic/claude-3.5-sonnet';
                const requestTime = new Date().toISOString();
                const requestBody = {
                    model: model,
                    messages: messages.map(m => ({ role: m.role, content: m.content })),
                    temperature: 0.7,
                    max_tokens: 2000
                };
                
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'AI Chat PWA'
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: messages.map(m => ({ role: m.role, content: m.content })),
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                hideTyping();

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const responseTime = new Date().toISOString();
                
                const assistantMessage = {
                    role: 'assistant',
                    content: data.choices[0].message.content,
                    timestamp: new Date().toISOString(),
                    model: model,
                    debug: {
                        request: requestBody,
                        response: data,
                        requestTime: requestTime,
                        responseTime: responseTime
                    }
                };

                messages.push(assistantMessage);
                renderMessages();
                saveMessages();

                // Auto-archive to GitHub if configured
                const githubToken = localStorage.getItem('github_token');
                const githubRepo = localStorage.getItem('github_repo');
                if (githubToken && githubRepo && messages.length % 10 === 0) {
                    await archiveToGitHub();
                }

            } catch (error) {
                hideTyping();
                addSystemMessage(`Error: ${error.message}`, true);
            }
        }

        function addSystemMessage(content, isError = false) {
            const systemMessage = {
                role: 'assistant',
                content: content,
                timestamp: new Date().toISOString(),
                error: isError
            };
            messages.push(systemMessage);
            renderMessages();
            saveMessages();
        }

        async function processPendingMessages() {
            if (pendingMessages.length === 0) return;

            addSystemMessage('Sending pending messages...');
            
            for (const msg of pendingMessages) {
                await sendMessage();
            }
            
            pendingMessages = [];
        }

        async function archiveToGitHub() {
            const githubToken = localStorage.getItem('github_token');
            const githubRepo = localStorage.getItem('github_repo');
            
            if (!githubToken || !githubRepo) return;

            try {
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `chat-${timestamp}-${Date.now()}.json`;
                
                const chatData = {
                    title: `Chat from ${new Date().toLocaleDateString()}`,
                    timestamp: new Date().toISOString(),
                    messages: messages,
                    metadata: {
                        totalMessages: messages.length,
                        userAgent: navigator.userAgent
                    }
                };

                const content = btoa(JSON.stringify(chatData, null, 2));

                await fetch(`https://api.github.com/repos/${githubRepo}/contents/chats/${filename}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Auto-archive chat session`,
                        content: content
                    })
                });

                console.log('Chat archived to GitHub');
            } catch (error) {
                console.error('GitHub archive failed:', error);
            }
        }

        function clearData() {
            if (confirm('Clear all chat data? This cannot be undone.')) {
                localStorage.removeItem('chat_messages');
                localStorage.removeItem('openrouter_api_key');
                localStorage.removeItem('github_token');
                localStorage.removeItem('github_repo');
                messages = [];
                renderMessages();
                loadSettings();
                updateStatus();
            }
        }
    </script>
</body>
</html>
